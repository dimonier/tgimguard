### tgimguard — анти-спам бот по тексту с картинок в Telegram

Бот для групп/супергрупп: извлекает текст с изображений через OpenAI и проверяет на наличие запрещённого текста.
Если текст содержит запрещённые строки, то удаляет сообщение, банит отправителя и уведомляет владельца чата.

### Возможности
- **OCR через OpenAI**: извлечение видимого текста из изображений
- **Фильтрация по подстрокам**: простые правила на основе списка запретных строк
- **Автодействия**: удаление сообщения, бан пользователя, уведомление владельца чата
- **Безопасность и логгирование**: ротация логов в `logs/tgimguard.log`

### Требования
- **Python**: >= 3.12
- **Telegram Bot Token**
- **OpenAI API Key** (или совместимый API, если меняете `OPENAI_BASE_URL`)

### Быстрый старт
1) Скопируйте конфиг:
```bash
cp env.example .env
```
2) Заполните `.env`: как минимум `TELEGRAM_BOT_TOKEN`, `OPENAI_API_KEY`.
3) Установите зависимости (вариант A — uv):
```bash
pip install uv && uv sync
```
   Вариант B — pip:
```bash
python -m venv .venv && .venv\Scripts\activate  # Windows
pip install -r <(uv export --format=requirements-txt)  # если есть uv
# или вручную: aiogram openai aiohttp python-dotenv pillow
```
4) Запуск:
```bash
python main.py
```
5) Добавьте бота в группу и выдайте ему права администратора (удаление сообщений, бан пользователей).

### Переменные окружения (.env)
- `TELEGRAM_BOT_TOKEN` — токен бота (обязательно)
- `OPENAI_API_KEY` — ключ OpenAI (обязательно)
- `OPENAI_BASE_URL` — базовый URL API (по умолчанию `https://api.openai.com/v1`)
- `OPENAI_MODEL_ID` — модель, по умолчанию `gpt-4o-mini`
- `PROHIBITED_STRINGS` — через `|`, подстроки для запрета (напр. `водительск|прав|buy now`)
- `IMAGE_COMPRESSION_THRESHOLD_KB` — порог размера, выше которого изображение ресайзится и преобразуются в JPEG
- `IMAGE_RESIZE_WIDTH_PX` — ширина в пикселях при ресайзе
- `CHAT_OWNER_ID` — ID владельца чата для уведомлений (опционально, иначе автоопределение)

### Как это работает
1) Пользователь отправляет изображение в группе
2) Бот скачивает файл, при необходимости сжимает/ресайзит
3) Отправляет в OpenAI как `image_url` и извлекает текст
4) Проверяет текст на вхождение любых `PROHIBITED_STRINGS`
5) При совпадении: удаляет сообщение, банит отправителя, уведомляет владельца

### Логи
- Файл: `logs/tgimguard.log` (суточная ротация, хранение 30 дней)

### Примечания
- Бот реагирует только в чатах типов `group` и `supergroup`
- Для корректной работы нужны права: удаление сообщений и бан пользователей
- Чем проще и короче список правил (`PROHIBITED_STRINGS`), тем меньше ложных срабатываний
